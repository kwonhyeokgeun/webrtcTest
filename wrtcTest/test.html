<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    
    <div id="video-box">
        <video class="my_video" style="width: 150px; height: 80px;"></video>
        <!--<video class="users_video" style="width: 150px; height: 80px;"></video>-->
    </div>
</head>
<body>
    
    <script type="module">
        import { io } from "https://cdn.socket.io/4.4.1/socket.io.esm.min.js";
        
        const socket = io('https://localhost:443', {secure: true, cors: { origin: '*' }});
        

        const pc_config = {
            iceServers: [
                {
                    urls: "stun:edu.uxis.co.kr"
                },
                {
                    urls: "turn:edu.uxis.co.kr?transport=tcp",
                            "username": "webrtc",
                            "credential": "webrtc100!"
                }
            ]
        }


        let roomId, userName; 
        let userNames={}; //userNames[socketId]="이름"
        let socketIds={}; //socketIds["이름"]=socketId

        let sendPC = {
            'user':{}, //카메라(유저 얼굴)
            'share':{}, //화면공유
        };
        let receivePCs = {
            'user':{},
            'share':{},
        };

        onload();
         

        function onload() {
            
            userName =  prompt("사용자 명");
            roomId = prompt("방 이름");

            socket.emit("meeting_room_info", {
                roomId: roomId,
                name: userName,
            });
        }

        //기존 방의 유저수와 방장이름 얻어옴
        socket.on("meeting_room_info",data =>{
            console.log(data.numOfUsers, data.roomLeader)
            meetingStart(roomId, data.roomLeader)
        })

        //먼저 접속한 모든 유저 정보받고 수신 pc, offer 생성
        socket.on("all_users", data =>{ 
            console.log("all_users : ",data.users)
            meetingAllUsersHandler(data)

        })

        //클라이언트 입장에서 보내는 역할의 peerConnection 객체에서 수신한 answer 메시지(sender_offer의 응답받음)
        socket.on("get_sender_answer", (data) => {
            try {
                console.log("get_sender_answer 받음")
                sendPC[data.purpose].setRemoteDescription(new RTCSessionDescription(data.answer));
            } catch (error) {
                console.error(error);
            }
        });

        

        function meetingStart(roomId, roomLeader){
            navigator.mediaDevices
                .getUserMedia({
                    audio: true,
                    video: true,
                })
                .then(async stream =>{
                    let myVideo = document.querySelector(".my_video");
                    myVideo.autoplay = true;
	                myVideo.playsinline = true;

                    //내 영상 비디오에 띄우기
                    let selfStream = new MediaStream();
                    selfStream.addTrack(stream.getVideoTracks()[0]);
                    myVideo.srcObject = selfStream;

                    //내 영상 전송용 pc와 offer생성
                    sendPC['user'] = createSenderPeerConnection(stream, 'user');
                    let offer = await createSenderOffer(sendPC['user']);

                    //방에 입장
                    socket.emit("meeting_join_room", {
                        roomId: roomId,
                        userName: userName,
                    });

                    //offer를 전송
                    await socket.emit("sender_offer", { 
                        offer,
                        roomId: roomId,
                        userName: userName,
                        purpose:'user'
                    });
                }).catch(error => {
                    console.error(error)
                })
        }

        //스트림 보내는 역할의 peerConnection 객체 생성
        function createSenderPeerConnection(stream, purpose, is_audio_true = 1) {
            let pc = new RTCPeerConnection(pc_config);
            
            pc.oniceconnectionstatechange = (e) => {
                //console.log(e);
            }

            pc.onicecandidate = (e) =>{
                if(e.candidate) {
                    socket.emit("sender_candidate", { //아직 서버측 안함
                        candidate: e.candidate,
                        purpose: purpose,
                    });
                }
            }

            if(stream) {
                var videoTrack = stream.getVideoTracks()[0];
                var audioTrack = stream.getAudioTracks()[0];
                pc.addTrack(videoTrack, stream);
                //console.log("audio:",is_audio_true)
                if(is_audio_true !=0)  //나중에 수정하기
                    pc.addTrack(audioTrack, stream);
            } else {
                console.log("no localStream");
            }

            return pc;
        }

        //보내는 역할의 peerConnection 객체에서 offer 전송 (통신 시작)
        async function createSenderOffer(pc){
            try {
                let offer = await pc.createOffer({ //보내기 위함으로 false임..?
                    offerToReceiveAudio: false,
                    offerToReceiveVideo: false,
                });
                await pc.setLocalDescription(new RTCSessionDescription(offer));
                
                console.log("send offer:",offer);

                return offer;
            } catch(error) {
                console.log(error);
            }
        }

        //받는 역할의 peerConnection 객체에서 offer 전송 (통신 시작)
        async function createReceiverOffer(pc) {
            try {
                let offer = await pc.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: true,
                });
                await pc.setLocalDescription(new RTCSessionDescription(offer));
                    
                return offer;
            } catch (error) {
                console.error(error);
            }
        }

        //기존 모든 유저들 영상을 받기위한 pc와 offer생성
        async function meetingAllUsersHandler(data) {
            try {
                let len = data.users.length;

                for(let i=0; i<len; i++) {
                    var socketId = data.users[i].socketId;
                    var userName = data.users[i].userName;

                    //기존 유저들 영상을 받을 pc와 offer를 생성
                    let pc = createReceiverPeerConnection(socketId, userName, 'user');
                    let offer = await createReceiverOffer(pc);
            
                    receivePCs['user'][socketId] = pc;
            
                    //수신 offer 보냄
                    await socket.emit("receiver_offer", {  //아직 서버측 안함
                        offer,
                        receiverSocketId: socket.id,
                        senderSocketId: socketId,
                        purpose: 'user',
                    });	
                }
            } catch(err) {
                console.error(err);
            }
        }

        //스트림 받는 역할의 peerConnection 객체 생성
        function createReceiverPeerConnection(senderSocketId, userName, purpose) {
            let pc = new RTCPeerConnection(pc_config);
            
            pc.oniceconnectionstatechange = (e) =>{
                //console.log(e);
            }

            pc.onicecandidate = (e) => {
                if(e.candidate) {
                    //수신 candidate 보냄
                    socket.emit("receiver_candidate", {  //아직 서버측 안함
                        candidate: e.candidate,
                        receiverSocketId: socket.id,
                        senderSocketId: senderSocketId,
                        purpose: purpose,
                        roomId : roomId,
                    });
                }
            }

            //스트림 보내는 쪽의 peerConnection에서 addTrack시 이벤트 발생
            var once = 1;
            pc.ontrack = (e) => {
                if(once == 1){
                    meetingOntrackHandler(e.streams[0], userName, senderSocketId);
                    console.log('한번만 나오는지')
                }
                once+=1;
            }

            return pc;
        }

        //유저별 stream을 video에 넣어줌(화면에 영상 띄움)
        function meetingOntrackHandler(stream, userName, senderSocketId) {
            console.log(userName,"meetingOntrackHandler 실행")
            /*if(receiveVideos['meeting'][senderSocketId]) return;
            userStreams['meeting'][senderSocketId] = stream;
            receiveVideos['meeting'][senderSocketId] = setMeetingVideo(userName, false, senderSocketId === roomLeader);
            receiveVideos['meeting'][senderSocketId].srcObject = stream;
            console.log(stream);*/
        }
    </script>
</body>
</html>