<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    

    <video class="my_video" style="width: 150px; height: 80px;"></video>
    <video class="users_video" style="width: 150px; height: 80px;"></video>
</head>
<body>
    
    <script type="module">
        import { io } from "https://cdn.socket.io/4.4.1/socket.io.esm.min.js";
        
        const socket = io('https://localhost:443', {secure: true, cors: { origin: '*' }});
        let roomId, userName; 
        let sendPC, receivePC={};
        const pc_config = {
            iceServers: [
                {
                    urls: "stun:edu.uxis.co.kr"
                },
                {
                    urls: "turn:edu.uxis.co.kr?transport=tcp",
                            "username": "webrtc",
                            "credential": "webrtc100!"
                }
            ]
        }



        onload();
         

        function onload() {
            
            userName =  prompt("사용자 명");
            roomId = prompt("방 이름");

            socket.emit("meeting_room_info", {
                roomId: roomId,
                name: userName,
            });
        }

        //기존 방의 유저수와 방장이름 얻어옴
        socket.on("meeting_room_info",data =>{
            console.log(data.numOfUsers, data.roomLeader)
            meetingStart(roomId, data.roomLeader)
        })

        //먼저 접속한 모든 유저 정보
        socket.on("all_users", data =>{ 
            for(let userInfo in data.users){
                let name = userInfo.userName;
                let id = userInfo.socketId;
                console.log("기존 유저 : ",name,id)
            }
        })

        function meetingStart(roomId, roomLeader){
            navigator.mediaDevices
                .getUserMedia({
                    audio: true,
                    video: true,
                })
                .then(async stream =>{
                    let myVideo = document.querySelector(".my_video");
                    myVideo.autoplay = true;
	                myVideo.playsinline = true;

                    //내 영상 비디오에 띄우기
                    let selfStream = new MediaStream();
                    selfStream.addTrack(stream.getVideoTracks()[0]);
                    myVideo.srcObject = selfStream;

                    //내 영상 전송용 pc와 offer생성
                    sendPC = createSenderPeerConnection(stream);
                    let offer = await createSenderOffer(sendPC);

                    //방에 입장
                    socket.emit("meeting_join_room", {
                        roomId: roomId,
                        userName: userName,
                    });

                    //offer를 전송
                    await socket.emit("sender_offer", { //아직 서버측 처리안함
                        offer,
                        roomId: roomId,
                        userName: userName,
                    });
                }).catch(error => {
                    console.error(error)
                })
        }

        //스트림 보내는 역할의 peerConnection 객체 생성
        function createSenderPeerConnection(stream, is_audio_true = 1) {
            let pc = new RTCPeerConnection(pc_config);
            
            pc.oniceconnectionstatechange = (e) => {
                //console.log(e);
            }

            pc.onicecandidate = (e) =>{
                if(e.candidate) {
                    socket.emit("sender_candidate", {
                        candidate: e.candidate,
                    });
                }
            }

            if(stream) {
                var videoTrack = stream.getVideoTracks()[0];
                var audioTrack = stream.getAudioTracks()[0];
                pc.addTrack(videoTrack, stream);
                //console.log("audio:",is_audio_true)
                if(is_audio_true !=0)
                    pc.addTrack(audioTrack, stream);
            } else {
                console.log("no localStream");
            }

            return pc;
        }

        //보내는 역할의 peerConnection 객체에서 offer 전송 (통신 시작)
        async function createSenderOffer(pc){
            try {
                let offer = await pc.createOffer({
                    offerToReceiveAudio: false,
                    offerToReceiveVideo: false,
                });
                await pc.setLocalDescription(new RTCSessionDescription(offer));
                
                console.log("send offer:",offer);

                return offer;
            } catch(error) {
                console.log(error);
            }
        }
    </script>
</body>
</html>